{%extends "layout.html"%}

{%block header%}
<div id="logotext">Analysis Results</div>
{%endblock%}

{%block body%}

<style>
	/* Website template by freewebsitetemplates.com */
	html {
		font-family: Arial, Helvetica, sans-serif, Century Gothic;
	}
	body {
		background-color: #03354e;
		font-family: Century Gothic;
		font-size: 14px;
		margin: 0;
	}
	img {
		border: 0;
	}
	div#loading {
		color: red;
		display: none;
	}

	/*------------------------------ HEADER ------------------------------*/
	#header {
		width: 960px;
		margin: 0 auto;
		padding: 30px 0 0 0;
		position: relative;
	}

	#logotext {
		font-size: 34px;
		font-family: Century Gothic;
		color: #CFCFCF;
		padding: 0 0 24px 0px;
	}

	/** Logo **/
	#logo {
		display: block;
		padding: 0 0 20px 20px;
	}

	/** Navigation **/
	#navigation {
		
		height: 47px;
		padding: 0 0 20px 4px;
		left: 0;
	}
	#navigation ul {
		background-image: url('./bg-menu.gif');
		background-repeat:  repeat-x;
		display: inline-block;
		height: 40px;
		width: 910px;
		list-style: none;
		margin: 0;
	}
	#navigation li {
		float: left;
		font-size: 16px;
		line-height: 40px;
		margin: 0 5px;
		text-align: center;
	}
	#navigation li.first {
		margin-left: 0;
		
	}
	#navigation li.selected {
		background-color: #b7c2c8;
	}
	#navigation a {
		color: #092f44;
		font-weight: bold;
		padding: 0 10px;
		text-decoration: none;
		text-shadow: 1px 1px 0 #eaeaea;
	}
	#navigation a:hover {
		color: #0a2d43;
	}


	/*------------------------------ CONTENTS ------------------------------*/

	.boxarea {
		padding: 2px 8px 2px 8px;
		border: 1px solid #778;
		background: #CFF;
	}

	#contents {
		padding: 0 0 20px;
	}
	#contents div.body {
		color: #fdfffa;
		width: 960px;
		margin: 0 auto 20px;
	}

	/** MAIN **/
	#main {
		background-color: #03354e;
		width: 630px;
		margin: 60px 10px 0 300px;
		padding: 20px 0 20px 20px;
	}
	#main span, #main p {
		color: #aeb4b4;
		font-size: 14px;
		line-height: 20px;
		margin: 0;
		padding-right: 20px;
		text-align: justify;
	}
	#main span {
		color: #fdfffa;
		font-size: 16px;
	}
	#main p a {
		color: #aeb4b4;
		font-weight: bold;
		text-decoration: none;
	}
	#main span a {
		color: #fdfffa;
		font-weight: bold;
		text-decoration: none;
	}
	#main ul {
		display: inline-block;
		list-style: none;
		height: 355px;
		margin: 0;
		padding: 0;
	}
	#main ul li {
		float: left;
		width: 315px;
	}
	#main ul li a {
		color: #fdfffa;
		display: block;
		height: 114px;
		margin: 0 40px 0 0;
		text-decoration: none;
	}
	#main ul li img {
		float: left;
	}
	#main ul li h3 {
		margin: 0;
		line-height: 25px;
		padding-top: 35px;
	}
	#main ul li p {
		clear: both;
		padding: 6px 40px 20px 0;
	}

	/** SIDEBAR **/
	#sidebar {
		float: left;
		width: 270px;
		margin: 0;
		padding: 20px 20px 0 10px;
	}
	#sidebar h3 {
		font-size: 16px;
		font-weight: bold;
		margin: 0 0 20px;
	}
	#sidebar ul {
		list-style: none;
		height: 420px;
		margin: 0;
		padding: 0;
	}
	#sidebar ul li {
		font-size: 14px;
		line-height: 20px;
		padding-bottom: 10px;
	}
	#sidebar ul li span {
		color: #456d87;
		display: block;
		font-size: 12px;
		line-height: 20px;
		margin-bottom: 10px;
	}
	#sidebar ul li span a {
		background-image: url('./bg-comment.gif');
		background-repeat:  no-repeat 7px 3px;
		color: #fffffb;
		display: inline-block;
		height: 20px;
		width: 20px;
		padding-bottom: 1px;
		padding-left: 12px;
		text-decoration: none;
	}

	/*------------------------------ CONTENTS TEXT ------------------------------*/
	#contents .background {
		background-color: #ffffff;
		min-height: 300px;
		width: 1200px;
		border-radius: 3px;
		margin: 0 auto;
		padding: 30px;
	}
	#contents div.background h3 {
		color: #0e2934;
		margin: 0px 0 20px 0;
		text-transform: uppercase;
	}



	/*------------------------------ FOOTER ------------------------------*/
	#footer {
		color: #456f7f;
		line-height: 20px;
		width: 940px;
		margin: 0 auto;
		padding: 10px 10px;
	}

	#footer ul.contacts {
		float: left;
		font-size: 12px;
		list-style: none;
		width: 300px;
		margin: 0;
		padding: 0 0 10px;
	}
	#footer ul.contacts h3 {
		font-size: 14px;
		margin: 0 0 10px;
		text-transform: uppercase;
	}
	#footer ul.contacts li span {
		float: left;
		width: 50px;
	}
	#footer ul.contacts li p {
		margin: 0 0 0 50px;
	}

	#connect {
		float: left;
		list-style: none;
		width: 140px;
		margin: 0;
		padding: 0;
	}
	#connect h3 {
		font-size: 14px;
		margin: 0 0 10px;
		text-transform: uppercase;
	}
	#connect li {
		padding: 0 0 5px;
	}
	#connect li a {
		color: #456f7f;
		font-size: 15px;
		text-decoration: none;
	}

	#newsletter {
		float: left;
		width: 500px;
		padding: 0 0 20px;
	}
	#newsletter p {
		font-size: 12px;
		margin: 0;
	}
	#newsletter p b {
		display: block;
		font-weight: 800;
		margin: 0 0 10px;
		text-transform: uppercase;
	}
	#newsletter form {
		margin: 4px 0 16px;
	}
	#newsletter .txtfield {
		background-image: url('./input.gif');
		background-repeat: no-repeat;
		color: #9c9c9c;
		height: 25px;
		line-height: 25px;
		width: 200px;
		border: 0;
		margin: 0 6px 0 0;
		padding: 0 10px;
	}
	#newsletter .button {
		background-image: url('./button-check.gif');
		background-repeat: no-repeat;
		cursor: pointer;
		height: 25px;
		width: 25px;
		border: 0;
		padding: 0;
	}

	#footer span.footnote {
		clear: both;
		display: block;
		font-size: 12px;
		margin: 40px 0 0;
		text-align: center;
	}

	.fig {
		font-family:Arial;
		font-size:10pt;
		color:darkgray;
	}
	#loadingmsg {
		color: black;
		background: #fff;
		padding: 10px;
		position: fixed;
		top: 50%;
		left: 50%;
		z-index: 100;
		margin-right: -25%;
		margin-bottom: -25%;
	}
	#loadingover {
		background: black;
		z-index: 99;
		width: 100%;
		height: 100%;
		position: fixed;
		top: 0;
		left: 0;
		-ms-filter: "progid:DXImageTransform.Microsoft.Alpha(Opacity=80)";
		filter: alpha(opacity=80);
		-moz-opacity: 0.8;
		-khtml-opacity: 0.8;
		opacity: 0.8;
	}
</style>
<script type="text/javascript" src="http://d3js.org/d3.v3.min.js"></script>


<script type="text/javascript">
	// show or hide loading annimation
	function show_loading(){
		document.getElementById("result").style.display = "none";
		document.getElementById("loading").style.display = "block";
	}
function showLoading() {
	document.getElementById("loadingmsg").style.display = "block";
	document.getElementById("loadingover").style.display = "block";
}
</script>

<script type="text/javascript">
// judge if there is input text
	function check_input(){
	  if (!document.getElementById("featureInfo").value || document.getElementById("featureInfo").value == "None")
	  {
	  	alert("Please select a variable for processing");
	  	return false;
	  }
	  else
	  {
		document.getElementById("hidden_options").value = document.getElementById("auto_options").innerHTML;
		return true;
	  }
	}
</script>

<script type="text/javascript">
	function check_range(){
		if (!document.getElementById("lower").value || !document.getElementById("upper").value || isNaN(document.getElementById("lower").value) || isNaN(document.getElementById("upper").value))
		{
			alert("Please input a valid number for processing");
			return false;
		}
		else
		{
			document.getElementById("hidden_options").value = document.getElementById("auto_options").innerHTML;
			return true;
		}
	}
</script>



<script type="text/javascript">
 function TextChange1(){
 	change_option();
 }
 function TextChange2(){
	  if (!document.getElementById("variable").value)
	  {
		change_option();
	  }
 }
 function change_option(){
	if (document.getElementById("auto_options").innerText != '')
	{
	 	document.getElementById("all_var").checked = true;
 		document.getElementById("auto_options").innerHTML = "<span style=color:red>Detecting variable change. Click Process button to regenerate value range.</span>";
		document.getElementById("button_csv").style.display = 'none';
	} 	
 }
</script>

<script>
	(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  
  ga('create', 'UA-57355594-1', 'auto');
  ga('send', 'pageview');
  
</script>


<div id='loadingmsg' style='display: none;'>Analyzing, please wait...</div>
<div id='loadingover' style='display: none;'></div>

<table>
	<tr>
		<td>
			<FORM action="{{ url_for('vatec_main') }}" method="post">
				<button type="submit" name="button2" style="height: 40px; width: 200px;" value=" Choose another variable" ><font size = 2>Choose another condition</font></button>
			</FORM>
		</td>
		<td>
			<FORM action="{{ url_for('download') }}" method="post">
				<input type="hidden" id="curr_condition" name="curr_condition" value="{{curr_condition}}" >
				<input type="hidden" id="filter_builder" name="filter_builder" value="{{filter_builder}}">
				<input type="hidden" id="sql_var_str" name="sql_var_str" value="{{sql_var_str}}">
				<button type="submit" id="button_csv" name="button_csv" style="height: 40px; width: 200px;" value=" Download output in csv "><font size = 2> Export output in CSV </font> </button>
			</FORM>
		</td>
		<!-- -->
		<!--<td>-->
			<!--<FORM action="{{ url_for('build_query') }}" method="post" onsubmit='showLoading();'>-->
				<!--<BUTTON Type="submit" style="height: 40px; width: 150px;" VALUE=" Clear the options " onclick="if (check_input()){show_loading();}else return false;"> <font size = 2>Clear the options </font></BUTTON>-->
				<!--<input type="text" value = '{{var}}' id="variable" name="variable" style="display:none;">-->
					<!--<input type="text" value = '{{disease}}' id="disease" name="disease" style="display:none;">-->
						<!--</FORM>-->
		<!--</td>-->
	<!-- -->
		<!-- -->
	</tr>
</table>


<FORM action="" method="post">
		<input type="text" id="hidden_options" name="hidden_options" style="display:none;">
		<input type="text" value = '{{var}}' id="variable" name="variable" style="display:none;">
</FORM>

<!--<div id="loading">Processing ...</div>-->

<BR>
<!--<div id="loading">Processing ...</div>-->
<div id="result">
	{% if modal_density_output_simple %}
		<b>Condition</b>: {{disease}} <br>
		<b>Feature</b>: {{featureName}} <br><br>
		<b>Number of UMLS terms</b>: {{num_cui_with_disease}}<br>
		<b>Number of UMLS terms matched a pattern</b>: {{num_cui_with_pattern}}<br>
		<b>Number of UMLS terms with temporal constrain</b>: {{num_cui_with_dur}}<br>
		<b>Number of Clinical Trials</b>: {{num_trials_with_disease}} <br><br>
		<b>Filter applied on Clinical Trials</b>:<br>
        {% for key in filter_dict %}
			<b>{{key}}</b>: {{filter_dict[key]}}<br>
        {% endfor %}
        <br>

		<!-- -->
		<!-- Google chart API -->
		<script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
		<script type="text/javascript">
			google.charts.load('current', {packages: ['corechart']});
			google.charts.setOnLoadCallback(drawChart);
			function drawChart() {

				// overlap densty function of ULMS terms based on duration (month)
				var data = new google.visualization.arrayToDataTable({{ modal_density_output_simple|safe }});
				var options = {
					title: 'Density of UMLS terms over month for '  + '{{featureName}}',
					curveType: 'function',
					hAxis: {
						title: 'Month for ' + '{{featureName}}',
						titleTextStyle: {
							color: '#333',
							fontSize: 15
						},
						gridlines: {
							color: '#797979',
							count: 4
						},
						format: '####.#'
					},
					vAxis: {
						title: 'Density',
						minValue: 0,
						gridlines: {
							color: '#797979',
							count: 5
						}
					},
					explorer: {},
					isStacked: true
				};
				var chart = new google.visualization.ColumnChart(document.getElementById('chart_div'));
				chart.draw(data, options);

				// distributi
				var data = new google.visualization.arrayToDataTable({{ modal_boundary_output_simple|safe }});
				var options = {
					title: 'Distribution of boundary of duration over month for '  + '{{featureName}}',
					curveType: 'function',
					hAxis: {
						title: 'Month for ' + '{{featureName}}',
						titleTextStyle: {
							color: '#333',
							fontSize: 15
						},
						gridlines: {
							color: '#797979',
							count: 4
						},
						format: '####.#'
					},
					vAxis: {
						title: 'Frequency of boundary',
						minValue: 0,
						gridlines: {
							color: '#797979',
							count: 5
						}
					},
					explorer: {},
					isStacked: true
				};
				var chart = new google.visualization.ColumnChart(document.getElementById('chart_boundary'));
				chart.draw(data, options);



				// distribution of pattern
				var data = new google.visualization.arrayToDataTable({{ pattern_freq_output_simple|safe }});
				var options = {
					title: 'Distribution of number of UMLS term over pattern for '  + '{{featureName}}',
					curveType: 'function',
					hAxis: {
						title: 'Pattern for ' + '{{featureName}}',
						titleTextStyle: {
							color: '#333',
							fontSize: 15
						},
						gridlines: {
							color: '#797979',
							count: 4
						},
						format: '####.#'
					},
					vAxis: {
						title: 'Frequency',
						minValue: 0,
						gridlines: {
							color: '#797979',
							count: 5
						}
					},
					explorer: {},
					isStacked: true
				};

				var chart = new google.visualization.ColumnChart(document.getElementById('chart_pattern'));
				chart.draw(data, options);


			}
		</script>
		<div id="chart_div" style="top: 0px; width: 1100px; height: 500px;"></div>
		<div id="chart_boundary" style="top: 0px; width: 1100px; height: 500px;"></div>
		<div id="chart_pattern" style="top: 0px; width: 1100px; height: 500px;"></div>
		<BR>

		<BR>
		<b>Top 100 events by frequency according to current term: {{featureName}}</b>
		<BR>
		<table border = 1 class="CSSTableGenerator">
		<tr><td><b>UMLS term</b></td><td><b>CUI</b></td><td><b>Semantic group</b></td><td><b>Semantic type</b></td><td><b>Frequency Prior To</b></td><td><b>Frequency After</b></td></tr>
		{% for name, cui, sty, sty_desc, group, freq_pt, freq_af in event_freq_output_simple %}
		<tr><td>{{name}}</td><td>{{cui}}</td><td>{{group}}</td><td>{{sty}} ({{sty_desc}})</td><td>{{freq_pt}}</td><td>{{freq_af}}</td></tr>
		{% endfor %}
		</table>
		<BR>

		<BR>
		<b>Top 100 terms by frequency that is co-occurrence with the current term: {{featureName}}</b>
		<BR>

		<table border = 1 class="CSSTableGenerator">
		<tr><td><b>UMLS term</b></td><td><b>CUI</b></td><td><b>Semantic group</b></td><td><b>Semantic type</b></td><td><b>Co-occurrence Frequency</b></td></tr>
		{% for name, cui, sty, sty_desc, group, freq in cooccur_freq_output_simple %}
		<tr><td>{{name}}</td><td>{{cui}}</td><td>{{group}}</td><td>{{sty}} ({{sty_desc}})</td><td>{{freq}}</td></tr>
		{% endfor %}
		</table>


			<FORM action="{{ url_for('analysis') }}" method="post" onsubmit='showLoading();'>
				<input type="hidden" name="disease" value="{{ disease }}">
				<input type="hidden" name="filter_builder" value="{{ filter_builder_tmp }}">
				<input type="hidden" name="sql_var_str" value="{{ sql_var_str_tmp }}">
				<input type="hidden" name="filter_description" value="{{ filter_description }}">
				<b>Analyze a co-occurrence Quantitative Eligibility Features:</b>:
				<SELECT id="featureInfo" name="featureInfo">
					<optgroup label="Please choose a variable to start">
						{% for name, cui, sty, sty_desc, group, freq in cooccur_freq_output_simple %}
							<option value = "{{cui}} {{sty}} {{name}}"> {{name}}({{sty}}), {{freq}}</option>
						{% endfor %}
					</optgroup>
				</SELECT>
				<br>
				<br>
				<INPUT type="submit" name="button2" width='200px' value=" Process " onclick="if (check_input()){show_loading();}else return false;">&nbsp;&nbsp;&nbsp;
				<input type="text" id="hidden_options" name="hidden_options" style="display:none;">
			</FORM>
</div>
{% endif %}

{%endblock%}
